#!/usr/bin/env python3
import re
from pathlib import Path

ROOT = Path.cwd()
PATTERN = re.compile(r"<<<<<<< HEAD\n(.*?)\n=======\n(.*?)\n>>>>>>> .*?\n", re.S)

files = list(ROOT.rglob("*.*"))
text_ext = {'.dart', '.yaml', '.yml', '.md', '.txt', '.json', '.py', '.xml', '.html', '.htm', '.sh', '.yaml', '.yml'}

changed = []
for p in files:
    if any(part.startswith('.git') for part in p.parts):
        continue
    if p.suffix.lower() not in text_ext:
        continue
    try:
        s = p.read_text(encoding='utf-8')
    except Exception:
        continue
    if '<<<<<<< HEAD' not in s:
        continue
    orig = p.with_suffix(p.suffix + '.orig')
    orig.write_text(s, encoding='utf-8')
    def repl(m):
        # keep the incoming section (group 2)
        return m.group(2) + "\n"
    new = PATTERN.sub(repl, s)
    # remove any stray markers that don't match the full pattern
    new = new.replace('<<<<<<< HEAD\n', '')
    new = new.replace('=======\n', '')
    new = re.sub(r'>>>>>>> .*?\n', '', new)
    if new != s:
        p.write_text(new, encoding='utf-8')
        changed.append(str(p.relative_to(ROOT)))

print('Files modified:', len(changed))
for c in changed:
    print('-', c)
